
name: CI/CD Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - promote-to-uat
          - promote-to-production
          - rollback-uat
          - rollback-production
      source_tag:
        description: 'Source tag (for promotions) or rollback tag'
        required: false
        default: 'ma-latest'
      approval_required:
        description: 'Require approval for production'
        type: boolean
        default: true

jobs:
  # Build PR images
  pr-build:
    if: github.event_name == 'pull_request'
    uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/docker-build-pr.yml@PAYMCLOUD-480-new-workflow-deploy
    secrets:
      registry_password: ${{ secrets.GITHUB_TOKEN }}

  # Build MA images on main
  main-build:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/docker-build-main.yml@PAYMCLOUD-480-new-workflow-deploy
    secrets:
      registry_password: ${{ secrets.GITHUB_TOKEN }}

  # Manual promotions and rollbacks
  promote-uat:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'promote-to-uat'
    uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/promote-to-uat.yml@PAYMCLOUD-480-new-workflow-deploy
    secrets:
      registry_password: ${{ secrets.GITHUB_TOKEN }}
    with:
      source_tag: ${{ inputs.source_tag }}

  promote-production:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'promote-to-production'
    uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/promote-to-prod.yml@PAYMCLOUD-480-new-workflow-deploy
    secrets:
      registry_password: ${{ secrets.GITHUB_TOKEN }}
    with:
      source_tag: ${{ inputs.source_tag }}
      approval_required: ${{ inputs.approval_required }}

  rollback-uat:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'rollback-uat'
    uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/rollback.yml@PAYMCLOUD-480-new-workflow-deploy
    secrets:
      registry_password: ${{ secrets.GITHUB_TOKEN }}
    with:
      environment: 'uat'
      rollback_tag: ${{ inputs.source_tag }}

  rollback-production:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'rollback-production'
    uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/rollback.yml@PAYMCLOUD-480-new-workflow-deploy
    secrets:
      registry_password: ${{ secrets.GITHUB_TOKEN }}
    with:
      environment: 'production'
      rollback_tag: ${{ inputs.source_tag }}
