
name: Docker GA Workflows

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - promote-to-uat
          - promote-to-production
          - rollback-uat
          - rollback-production
      source_tag:
        description: 'Source tag (for promotions) or rollback tag'
        required: false
        default: 'ma-latest'
      approval_required:
        description: 'Require approval for production'
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read
  packages: write
  pull-requests: write
  issues: write

jobs:
  # Build PR images
  pr-build:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Build and promote PR image (composite)
        uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/build-pr@PAYMCLOUD-480-new-workflow-deploy
        with:
          registry_password: ${{ secrets.GITHUB_TOKEN }}
          dockerfile_path: './test-docker/Dockerfile'
          docker_context: './test-docker'

  # Build MA images on main
  main-build:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Build and promote MA image (composite)
        uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/build-and-promote-ma@PAYMCLOUD-480-new-workflow-deploy
        with:
          registry_password: ${{ secrets.GITHUB_TOKEN }}
          dockerfile_path: './test-docker/Dockerfile'
          docker_context: './test-docker'

  # Manual promotions and rollbacks
  promote-uat:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'promote-to-uat'
    runs-on: ubuntu-latest
    steps:
      - name: Promote to UAT (composite)
        uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/promote-to-uat@PAYMCLOUD-480-new-workflow-deploy
        with:
          registry_password: ${{ secrets.GITHUB_TOKEN }}
          source_tag: ${{ inputs.source_tag }}

  promote-production:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'promote-to-production'
    runs-on: ubuntu-latest
    environment:
      name: production-approval
    steps:
      - name: Promote to Production (composite)
        uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/promote-to-prod@PAYMCLOUD-480-new-workflow-deploy
        with:
          registry_password: ${{ secrets.GITHUB_TOKEN }}
          source_tag: ${{ inputs.source_tag }}

  rollback-uat:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'rollback-uat'
    runs-on: ubuntu-latest
    steps:
      - name: Rollback UAT (composite)
        uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/rollback@PAYMCLOUD-480-new-workflow-deploy
        with:
          registry_password: ${{ secrets.GITHUB_TOKEN }}
          environment: 'uat'
          rollback_tag: ${{ inputs.source_tag }}

  rollback-production:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'rollback-production'
    runs-on: ubuntu-latest
    environment:
      name: production-approval
    steps:
      - name: Rollback Production (composite)
        uses: pagopa/eng-github-actions-iac-template/global/docker-golden-image-workflows/rollback@PAYMCLOUD-480-new-workflow-deploy
        with:
          registry_password: ${{ secrets.GITHUB_TOKEN }}
          environment: 'production'
          rollback_tag: ${{ inputs.source_tag }}
